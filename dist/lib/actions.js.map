{"version":3,"sources":["lib/actions.js"],"names":[],"mappings":"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","file":"lib/actions.js","sourcesContent":["\nvar ws = require(\"./ws\");\nvar logger  = require('./logger');\nvar EventEmitter = require('events').EventEmitter;\n\nfunction Actions(connection){\n\tvar self = this;\n\tvar emitter = new EventEmitter();\n\n\tprocess.nextTick(()=>emitter.emit(\"start\",connection));\n\n\tconnection.on(\"message\", function (message) {\n\t\tif(message.type !== \"utf8\"){\n\t\t\tconnection.sendError(\"Server does not accept websockets message of type \" + message.type);\n\t\t\treturn;\n\t\t}\n\t\tvar json = null;\n\t\ttry{\n\t\t\tjson = JSON.parse(message.utf8Data);\n\t\t}catch(error){\n\t\t\tconnection.sendError(\"Cannot parse to json \" + message.utf8Data);\n\t\t\treturn;\n\t\t}\n\t\tvar action = json.action;\n\t\tvar data = json.data;\n\n\t\tif(!action){\n\t\t\tconnection.sendError(\"No action defined in json \" + message.utf8Data);\n\t\t\treturn;\n\t\t}\n\n\t\tif(!emitter.listeners(\"on\" + action).length>0){\n\t\t\tconnection.sendError(\"No action defined in the server for \" + action);\n\t\t\treturn;\n\t\t}\n\t\temitter.emit(\"on\" + action, data);\n    });\n    connection.on(\"close\", function (reasonCode, description) {\n    \temitter.emit(\"close\", {reasonCode:reasonCode, description:description});\n    });\n\n\t\n\n\tthis.start = function(f){\n\t\temitter.on(\"start\",f);\n\t\treturn self;\n\t};\n\tthis.on = function(name, f){\n\n\t\temitter.on(\"on\" + name,async function(data){\n\t\t\tfunction g(){\n\t\t\t\treturn f(data);\n\t\t\t}\n\t\t\ttry{\n\t\t\t\tvar r = g();\n\t\t\t}catch(error){\n\t\t\t\tconsole.log(\"Error captured in action try-catch \" + error.message);\n\t\t\t\tlogger.info(error);\n\t\t\t\tconnection.sendError(error.message);\n\t\t\t}\n\t\t});\n\t\treturn self;\n\t};\n\tthis.close = function(f){\n\t\temitter.on(\"close\",f);\n\t\treturn self;\n\t};\n};\n\nmodule.exports = function(connection){\n\treturn new Actions(connection);\n};"],"sourceRoot":"/source/"}